---
title: "Final_project"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)

covid_raw <- 
  read_csv("data/10-20-2020.csv") %>% 
  filter(Country_Region == "US") %>% 
  select(
    fips = FIPS, 
    county_name = Admin2, 
    state = Province_State, 
    confirmed = Confirmed, 
    deaths = Deaths
  ) %>% 
  mutate(fips = as.integer(fips))
  
```

###Race data
```{r}
race_raw <- 
  read_tsv("data/cdc_race.txt", n_max = 15705) %>% 
  rename(
    county = County, 
    county_code = `County Code`, 
    race = Race, 
    population = Population
  ) %>% 
  mutate(county_code = as.integer(county_code))

#Getting total population of each county
total_pop <- 
  race_raw %>% 
  filter(Notes == "Total") %>% 
  filter(!is.na(county_code)) %>% 
  select(county_code, population) %>% 
  rename(total_pop = population)

race <- 
  race_raw %>%
  filter(is.na(Notes)) %>% 
  left_join(total_pop, by = "county_code") %>% 
  mutate(
    race = 
      recode(
        race, 
        "American Indian or Alaska Native" = "native", 
        "Asian or Pacific Islander" = "asian", 
        "Black or African American" = "black", 
        "White" = "white"
      ), 
    prop = population / total_pop
  ) %>% 
  select(-population, -`Race Code`, -Notes, -total_pop, -county) %>% 
  spread(key = race, value = prop)
```


###Ethnicity data
```{r}
ethnicity <- 
  read_tsv("data/cdc_ethnicity.txt", n_max = 9427) %>% 
  rename(
    county = County, 
    county_code = `County Code`, 
    ethnicity = Ethnicity, 
    population = Population
  ) %>% 
  mutate(county_code = as.integer(county_code)) %>%
  filter(ethnicity == "Hispanic or Latino") %>% 
  left_join(total_pop, by = "county_code") %>% 
  mutate(hispanic = population / total_pop) %>% 
  select(county_code, hispanic)
```

###Gender data
```{r}
gender <- 
  read_tsv("data/cdc_gender.txt", n_max = 9427) %>% 
  rename(
    county = County, 
    county_code = `County Code`, 
    gender = Gender, 
    population = Population
  ) %>% 
  mutate(county_code = as.integer(county_code)) %>%
  filter(gender == "Female") %>% 
  left_join(total_pop, by = "county_code") %>% 
  mutate(female = population / total_pop) %>% 
  select(county_code, female)
```


###Merging datasets 
```{r}
covid <- 
  covid_raw %>% 
  left_join(total_pop, by = c("fips" = "county_code")) %>% 
  left_join(race, by = c("fips" = "county_code")) %>% 
  left_join(ethnicity, by = c("fips" = "county_code")) %>%
  left_join(gender, by = c("fips" = "county_code")) %>%
  write_csv("covid_cleaned.csv")
```






