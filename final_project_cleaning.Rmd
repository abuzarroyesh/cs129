---
title: "Final_project"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)

covid_raw <- 
  read_csv("data/10-20-2020.csv") %>% 
  filter(Country_Region == "US") %>% 
  select(
    fips = FIPS, 
    county_name = Admin2, 
    state = Province_State, 
    confirmed = Confirmed, 
    deaths = Deaths
  ) %>% 
  mutate(fips = as.integer(fips))
```


```{r}
data <- 
  read_tsv("data/pcen_v2019_y19.txt", col_names = FALSE) %>% 
  mutate(
    series = str_sub(X1, start = 1L, end = 4L), 
    estimate_year = str_sub(X1, start = 5L, end = 8L), 
    estimate_month = str_sub(X1, start = 9L, end = 9L), 
    fips = str_sub(X1, start = 10L, end = 14L),
    # county_fips = str_sub(X1, start = 12L, end = 14L), 
    age = str_sub(X1, start = 15L, end = 16L),
    race_sex = str_sub(X1, start = 17L, end = 17L), 
    hispanic_origin = str_sub(X1, start = 18L, end = 18L),
    population = str_sub(X1, start = 19L, end = 26L),
    race_sex = 
      recode(
        race_sex, 
        "1" = "m white", 
        "2" = "f white", 
        "3" = "m black", 
        "4" = "f black", 
        "5" = "m native", 
        "6" = "f native", 
        "7" = "m asian", 
        "8" = "f asian"
      ),
    hispanic_origin = if_else(hispanic_origin == 1, "non-hispanic", "hispanic"),
    sex = str_sub(race_sex, start = 1L, end = 1L),
    race = str_sub(race_sex, start = 3L)
  ) %>% 
  mutate_at(vars(fips, age, population), as.integer) %>% 
  mutate(
    age_bracket = 
      case_when(
        age >= 0 & age <= 4   ~ "age1",
        age >= 5 & age <= 17  ~ "age2",
        age >= 18 & age <= 29 ~ "age3",
        age >= 30 & age <= 39 ~ "age4",
        age >= 40 & age <= 49 ~ "age5",
        age >= 50 & age <= 64 ~ "age6",
        age >= 65 & age <= 74 ~ "age7",
        age >= 75 & age <= 84 ~ "age8",
        age >= 85             ~ "age9"
      )
  ) %>% 
  select(-X1, -race_sex, -age) 

```


### What age means 
"age1" = "age0-4"
"age2" = "age5-17"
"age3" = "age18-29"
"age4" = "age30-39"
"age5" = "age40-49"
"age6" = "age50-64"
"age7" = "age65-74"
"age8" = "age75-84"
"age9" = "age85+"

```{r}
##Writing function to extract percentage for each category
summary_stats <- function(variable_name){
  variable_name = enquo(variable_name)
  
  data %>% 
  group_by(fips, !!variable_name) %>% 
  summarize(population = sum(population), .groups = "drop") %>% 
  group_by(fips) %>% 
  mutate(prop = population / sum(population)) %>% 
  select(-population) %>% 
  spread(key = !!variable_name, value = prop)
}

##Running the previous function on all categories
demographics <- 
  summary_stats(race) %>% 
  left_join(summary_stats(sex), by = "fips") %>%
  left_join(summary_stats(hispanic_origin), by = "fips") %>% 
  left_join(summary_stats(age_bracket), by = "fips") %>% 
  select(-white, -m, -`non-hispanic`, -`age1`) %>% #Dropping on column from each category
  rename(female = f)
```

```{r}
##Merging the datasets
covid_raw %>% 
  left_join(
    read_csv("data/county_populations.csv"), by = c("fips" = "county_code")
  ) %>% 
  left_join(demographics, by = "fips") %>% 
  write_csv("covid_cleaned.csv")
```



